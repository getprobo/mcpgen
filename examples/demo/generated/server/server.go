// Code generated by mcpgen. DO NOT EDIT.

package server

import (
	"context"
	"log"

	mcp_v1 "demo/generated"
	"demo/generated/types"
	"github.com/modelcontextprotocol/go-sdk/mcp"
	"go.probo.inc/mcpgen/mcputil"
)

type toolResolver struct{ *mcp_v1.Resolver }
type promptResolver struct{ *mcp_v1.Resolver }
type resourceResolver struct{ *mcp_v1.Resolver }

// Server represents the MCP server
type Server struct {
	mcpServer        *mcp.Server
	resolver         *mcp_v1.Resolver
	toolResolver     *toolResolver
	promptResolver   *promptResolver
	resourceResolver *resourceResolver
}

// New creates a new MCP server instance
func New(resolver *mcp_v1.Resolver) *Server {
	return &Server{
		resolver:         resolver,
		toolResolver:     &toolResolver{resolver},
		promptResolver:   &promptResolver{resolver},
		resourceResolver: &resourceResolver{resolver},
	}
}

// Start initializes and starts the MCP server
func (s *Server) Start(ctx context.Context) error {
	s.mcpServer = mcp.NewServer(
		&mcp.Implementation{
			Name:    "demo-server",
			Version: "1.0.0",
		},
		nil,
	)

	s.registerToolHandlers()
	s.registerResourceHandlers()
	s.registerPromptHandlers()

	transport := &mcp.StdioTransport{}
	log.Printf("MCP server %s v%s starting...\n", "demo-server", "1.0.0")

	if err := s.mcpServer.Run(ctx, transport); err != nil {
		return err
	}

	return nil
}

func (s *Server) registerToolHandlers() {
	mcp.AddTool(
		s.mcpServer,
		&mcp.Tool{
			Name:         "calculate",
			Description:  "Perform basic arithmetic operations",
			InputSchema:  types.CalculateToolInputSchema,
			OutputSchema: types.CalculateToolOutputSchema,
		},
		s.toolResolver.Calculate,
	)
	mcp.AddTool(
		s.mcpServer,
		&mcp.Tool{
			Name:        "calculate2",
			Description: "Perform basic arithmetic operations",
			InputSchema: types.Calculate2ToolInputSchema,
		},
		s.toolResolver.Calculate2,
	)
	mcp.AddTool(
		s.mcpServer,
		&mcp.Tool{
			Name:         "create_task",
			Description:  "Create a new task",
			InputSchema:  types.CreateTaskToolInputSchema,
			OutputSchema: types.CreateTaskToolOutputSchema,
		},
		s.toolResolver.CreateTask,
	)
	mcp.AddTool(
		s.mcpServer,
		&mcp.Tool{
			Name:        "search",
			Description: "Search for items",
			InputSchema: types.SearchToolInputSchema,
		},
		s.toolResolver.Search,
	)
	mcp.AddTool(
		s.mcpServer,
		&mcp.Tool{
			Name:        "get_history",
			Description: "Get calculation history",
			InputSchema: types.GetHistoryToolInputSchema,
		},
		s.toolResolver.GetHistory,
	)
}

func (s *Server) registerResourceHandlers() {
	s.mcpServer.AddResource(
		&mcp.Resource{
			URI:         "docs://readme",
			Name:        "Demo README",
			Description: "Documentation for the demo server",
			MIMEType:    "text/markdown",
		},
		s.resourceResolver.DemoREADME,
	)
	s.mcpServer.AddResourceTemplate(
		&mcp.ResourceTemplate{
			URITemplate: "task://{id}",
			Name:        "Task Details",
			Description: "Get details for a specific task",
			MIMEType:    "application/json",
		},
		s.resourceResolver.TaskDetails,
	)
	s.mcpServer.AddResourceTemplate(
		&mcp.ResourceTemplate{
			URITemplate: "result://{operation}",
			Name:        "Last Result",
			Description: "Get the last result for a specific operation",
			MIMEType:    "application/json",
		},
		s.resourceResolver.LastResult,
	)
}

func (s *Server) registerPromptHandlers() {
	mcputil.AddPrompt(
		s.mcpServer,
		&mcp.Prompt{
			Name:        "task_help",
			Description: "Get help with task management",
			Arguments: []*mcp.PromptArgument{
				{
					Name:        "topic",
					Description: "The help topic (tasks, priorities, etc)",
					Required:    false,
				},
				{
					Name:        "detailed",
					Description: "Whether to show detailed help",
					Required:    false,
				},
			},
		},
		s.promptResolver.TaskHelp,
	)
	mcputil.AddPrompt(
		s.mcpServer,
		&mcp.Prompt{
			Name:        "math_help",
			Description: "Get help with mathematical operations",
			Arguments: []*mcp.PromptArgument{
				{
					Name:        "operation",
					Description: "The operation to get help with",
					Required:    false,
				},
			},
		},
		s.promptResolver.MathHelp,
	)
}
func (r *toolResolver) Calculate(ctx context.Context, req *mcp.CallToolRequest, input *types.CalculateInput) (*mcp.CallToolResult, types.CalculateOutput, error) {
	return r.Resolver.Calculate(ctx, req, input)
}
func (r *toolResolver) Calculate2(ctx context.Context, req *mcp.CallToolRequest, input *types.Calculate2Input) (*mcp.CallToolResult, map[string]any, error) {
	return r.Resolver.Calculate2(ctx, req, input)
}
func (r *toolResolver) CreateTask(ctx context.Context, req *mcp.CallToolRequest, input *types.CreateTaskInput) (*mcp.CallToolResult, types.CreateTaskOutput, error) {
	return r.Resolver.CreateTask(ctx, req, input)
}
func (r *toolResolver) Search(ctx context.Context, req *mcp.CallToolRequest, input *types.SearchInput) (*mcp.CallToolResult, map[string]any, error) {
	return r.Resolver.Search(ctx, req, input)
}
func (r *toolResolver) GetHistory(ctx context.Context, req *mcp.CallToolRequest, input *types.GetHistoryInput) (*mcp.CallToolResult, map[string]any, error) {
	return r.Resolver.GetHistory(ctx, req, input)
}
func (r *resourceResolver) DemoREADME(ctx context.Context, req *mcp.ReadResourceRequest) (*mcp.ReadResourceResult, error) {
	return r.Resolver.DemoREADME(ctx, req)
}
func (r *resourceResolver) TaskDetails(ctx context.Context, req *mcp.ReadResourceRequest) (*mcp.ReadResourceResult, error) {
	return r.Resolver.TaskDetails(ctx, req)
}
func (r *resourceResolver) LastResult(ctx context.Context, req *mcp.ReadResourceRequest) (*mcp.ReadResourceResult, error) {
	return r.Resolver.LastResult(ctx, req)
}
func (r *promptResolver) TaskHelp(ctx context.Context, req *mcp.GetPromptRequest, args types.TaskHelpArgs) (*mcp.GetPromptResult, error) {
	return r.Resolver.TaskHelp(ctx, req, args)
}
func (r *promptResolver) MathHelp(ctx context.Context, req *mcp.GetPromptRequest, args types.MathHelpArgs) (*mcp.GetPromptResult, error) {
	return r.Resolver.MathHelp(ctx, req, args)
}
