// Code generated by mcpgen. DO NOT EDIT.

package generated

import (
	"context"
	"log"

	"github.com/modelcontextprotocol/go-sdk/mcp"
	"go.probo.inc/mcpgen/pkg/mcputil"
)

// Server represents the MCP server
type Server struct {
	mcpServer *mcp.Server
	resolver  *Resolver
}

// New creates a new MCP server instance
func New(resolver *Resolver) *Server {
	return &Server{
		resolver: resolver,
	}
}

// Start initializes and starts the MCP server
func (s *Server) Start(ctx context.Context) error {
	// Create MCP server
	s.mcpServer = mcp.NewServer(&mcp.Implementation{
		Name:    "demo-server",
		Version: "1.0.0",
	}, nil)

	// Register tool handlers
	s.registerToolHandlers()
	s.registerResourceHandlers()
	s.registerPromptHandlers()

	// Start server with stdio transport
	transport := &mcp.StdioTransport{}
	log.Printf("MCP server %s v%s starting...\n", "demo-server", "1.0.0")

	if err := s.mcpServer.Run(ctx, transport); err != nil {
		return err
	}

	return nil
}

// registerToolHandlers registers all tool handlers
func (s *Server) registerToolHandlers() {
	mcp.AddTool(s.mcpServer, &mcp.Tool{
		Name:        "calculate",
		Description: "Perform basic arithmetic operations",
		InputSchema: CalculateToolInputSchema,
	}, s.resolver.CalculateTool)
	mcp.AddTool(s.mcpServer, &mcp.Tool{
		Name:        "create_task",
		Description: "Create a new task",
		InputSchema: CreateTaskToolInputSchema,
	}, s.resolver.CreateTaskTool)
	mcp.AddTool(s.mcpServer, &mcp.Tool{
		Name:        "search",
		Description: "Search for items",
		InputSchema: SearchToolInputSchema,
	}, s.resolver.SearchTool)
	mcp.AddTool(s.mcpServer, &mcp.Tool{
		Name:        "get_history",
		Description: "Get calculation history",
		InputSchema: GetHistoryToolInputSchema,
	}, s.resolver.GetHistoryTool)
}

// registerResourceHandlers registers all resource handlers
func (s *Server) registerResourceHandlers() {
	s.mcpServer.AddResource(&mcp.Resource{
		URI:         "docs://readme",
		Name:        "Demo README",
		Description: "Documentation for the demo server",
		MIMEType:    "text/markdown",
	}, s.resolver.DemoREADMEResource)
	s.mcpServer.AddResourceTemplate(&mcp.ResourceTemplate{
		URITemplate: "task://{id}",
		Name:        "Task Details",
		Description: "Get details for a specific task",
		MIMEType:    "application/json",
	}, s.resolver.TaskDetailsResource)
	s.mcpServer.AddResourceTemplate(&mcp.ResourceTemplate{
		URITemplate: "result://{operation}",
		Name:        "Last Result",
		Description: "Get the last result for a specific operation",
		MIMEType:    "application/json",
	}, s.resolver.LastResultResource)
}

// registerPromptHandlers registers all prompt handlers
func (s *Server) registerPromptHandlers() {
	mcputil.AddPrompt(s.mcpServer, &mcp.Prompt{
		Name:        "task_help",
		Description: "Get help with task management",
		Arguments: []*mcp.PromptArgument{
			{
				Name:        "topic",
				Description: "The help topic (tasks, priorities, etc)",
				Required:    false,
			},
			{
				Name:        "detailed",
				Description: "Whether to show detailed help",
				Required:    false,
			},
		},
	}, s.resolver.TaskHelpPrompt)
	mcputil.AddPrompt(s.mcpServer, &mcp.Prompt{
		Name:        "math_help",
		Description: "Get help with mathematical operations",
		Arguments: []*mcp.PromptArgument{
			{
				Name:        "operation",
				Description: "The operation to get help with",
				Required:    false,
			},
		},
	}, s.resolver.MathHelpPrompt)
}
